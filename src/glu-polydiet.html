<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="shared/polydiet-icons.html">
<link rel="import" href="shared/shared-styles.html">
<link rel="import" href="shared/nutrients-behavior.html">
<link rel="import" href="foods-grid.html">
<link rel="import" href="weekly-grid.html">
<link rel="import" href="weekly-stats.html">
<link rel="import" href="pd-data.html">
<dom-module id="glu-polydiet">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
      }
      
      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }
      
      #mainSection {
        padding: 0 1rem;
      }
      
      footer p.info {
        margin-top: 2rem;
        color: #666;
        font-size: 75%;
        text-align: center;
      }
      
      app-header {
        z-index: 1;
      }
      
      #tabs {
        margin-bottom: 10px;
      }
    </style>
    <pd-data id="data" food-data="{{foods}}" weekly-products="{{weeklyProducts}}"></pd-data>
    <div class="container">
      <app-header reveals>
        <app-toolbar>
          <paper-menu-button>
            <paper-icon-button icon="polydiet-icons:menu" class="dropdown-trigger"></paper-icon-button>
            <paper-menu class="dropdown-content" id="nutrientsMenu">
              <template is="dom-repeat" items="{{nutrients}}" as="nutrient">
                <paper-item role="menuitemcheckbox">
                  <paper-item-body>
                    <paper-checkbox checked="{{!nutrient.hidden}}">[[nutrient.name]]</paper-checkbox>
                  </paper-item-body>
                </paper-item>
              </template>
            </paper-menu>
          </paper-menu-button>
          <div main-title>PolyDiet</div>
        </app-toolbar>
      </app-header>
      <section role="main" id="mainSection">
        <paper-tabs selected="{{selectedTab}}" no-slide id="tabs">
          <paper-tab>Tygodniówka</paper-tab>
          <paper-tab>Produkty</paper-tab>
          <paper-tab>Statystyki</paper-tab>
        </paper-tabs>
        <iron-pages selected="{{selectedTab}}">
          <div>
            <weekly-grid id="weeklyList" nutrients="[[nutrients]]" products="[[weeklyProducts]]" sums="[[sums]]" on-remove-used="removeFoodsFromList"
              on-amount-updated="updateAmount">
              </foods-grid>
          </div>
          <div>
            <foods-grid id="foodsList" foods="[[foods]]" nutrients="[[nutrients]]" on-add-to-list="addFoodToList"></foods-grid>
          </div>
          <div>
            <weekly-stats nutrients="[[nutrients]]" sums="[[sums]]" id="weeklyStats"></weekly-stats>
          </div>
        </iron-pages>
      </section>
      <footer>
        <p class="info">Dane o składnikach odżywczych pochodzą z ogólnodostępnej bazy <a href="https://www.ars.usda.gov/northeast-area/beltsville-md/beltsville-human-nutrition-research-center/nutrient-data-laboratory/docs/usda-national-nutrient-database-for-standard-reference/">USDA</a>.</p>
      </footer>
    </div>
  </template>
  <script>
    Polymer({
      is: 'glu-polydiet',
      properties: {
        selectedTab: {
          type: Number,
          value: 0
        },
        foods: {
          type: Array,
          notify: true,
          value: []
        },
        weeklyProducts: {
          type: Array,
          notify: true,
          value: []
        },
        sums: {
          type: Array,
          value: Array.apply(null, {
            length: 44
          }).map(function () {
            return 0;
          })
        },
      },
      behaviors: [GluBehaviors.Nutrients],
      observers: [
        'recalculateSums(weeklyProducts.*)'
      ],
      recalculateSums: function (products) {
        if (!this.sums) return;

        this.sums = this.sums.map(function (id, index) {
          var sum = products.base.reduce(function (sum, product) {
            var value = index === 0 ? product.a : product.n[index - 1];

            return value > 0 ? sum + value : sum;
          }, 0);

          return sum;
        });
      },
      _recalculateValues: function (foodWithAmount, factor) {
        foodWithAmount.n = foodWithAmount.n.map(function (n) {
          return n > 0 ? factor * n : n;
        });
      },

      addFoodToList: function (e, data) {
        var foodWithAmount,
          existingFood;

        if (data.amount > 0) {
          existingFood = this.weeklyProducts.filter(function (f) {
            return f.id === data.food.id;
          });

          if (existingFood.length > 0) {
            data.amount += existingFood[0].a;
            // remove existing, as it is easy to force mutation changes
            this.splice('weeklyProducts', this.weeklyProducts.indexOf(existingFood[0]), 1);
          }

          foodWithAmount = Object.assign({}, data.food, {
            a: data.amount
          });
          this._recalculateValues(foodWithAmount, foodWithAmount.a / 100);
          this.push("weeklyProducts", foodWithAmount);
        }
      },
      updateAmount: function (e, data) {
        var existingFood,
          foodId;

        existingFood = this.weeklyProducts.filter(function (f) {
          return f.id === data.id;
        })[0];

        this._recalculateValues(existingFood, data.value / existingFood.a);
        existingFood.a = data.value;
        this.notifyPath(["weeklyProducts", this.weeklyProducts.indexOf(existingFood), "n"]);
      },
      removeFoodsFromList: function (e, data) {
        data.products.forEach(function (food) {
          for (var i = 0; i < this.weeklyProducts.length; i++) {
            if (this.weeklyProducts[i].id === food.id) {
              this.splice("weeklyProducts", i, 1);
              return;
            }
          }
        }.bind(this));
      }
    });
  </script>
</dom-module>