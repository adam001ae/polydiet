<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="shared/polydiet-icons.html">
<link rel="import" href="shared/shared-styles.html">
<link rel="import" href="shared/grid-sort-behavior.html">
<link rel="import" href="foods-grid.html">
<link rel="import" href="weekly-grid.html">
<link rel="import" href="pd-data.html">
<dom-module id="glu-polydiet">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
      }
      
      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }
      
      #mainSection {
        padding: 0 1rem;
      }
      
      #addFood {
        margin: 1rem;
      }
      
      footer p.info {
        margin-top: 2rem;
        color: #666;
        font-size: 75%;
        text-align: center;
      }
    </style>
    <pd-data id="data" food-data="{{foods}}" weekly-products="{{weeklyProducts}}"></pd-data>
    <div class="container">
      <app-header reveals>
        <app-toolbar>
          <div main-title>PolyDiet</div>
        </app-toolbar>
      </app-header>
      <section role="main" id="mainSection">
        <paper-tabs selected="{{selectedTab}}" no-slide>
          <paper-tab>Tygodniówka</paper-tab>
          <paper-tab>Produkty</paper-tab>
          <paper-tab>Statystyki</paper-tab>
        </paper-tabs>
        <iron-pages selected="{{selectedTab}}">
          <div>
            <weekly-grid id="weeklyList" products="[[weeklyProducts]]" on-remove-used="removeFoodsFromList">
              </foods-grid>
          </div>
          <div>
            <paper-input label="Filtruj produkty" type="search" placeholder="Wpisz minimum dwa znaki" autosave="test" results="5" value="{{prodSearch}}"></paper-input>
            <foods-grid id="foodsList" foods="[[sortedGrid]]" on-sort-changed="sortOrderChanged" on-selected-changed="selectedFoodChanged"></foods-grid>
            <paper-fab icon="polydiet-icons:add" id="addFood" disabled="[[!isFoodSelected]]" on-tap="openAddFoodModal"></paper-fab>
          </div>
          <div>
            <p>Statystyki w trakcie realizacji</p>
          </div>
        </iron-pages>
      </section>
      <footer>
        <p class="info">Dane o składnikach odżywczych pochodzą z ogólnodostępnej bazy <a href="https://www.ars.usda.gov/northeast-area/beltsville-md/beltsville-human-nutrition-research-center/nutrient-data-laboratory/docs/usda-national-nutrient-database-for-standard-reference/">USDA</a>.</p>
      </footer>
    </div>
    <paper-dialog modal id="addSelectedFoodModal">
      <h2>Dodaj produkt &quot;[[selectedFood.t]]&quot;</h2>
      <p>
        <paper-input label="Waga w gramach" type="number" placeholder="Wpisz wagę w gramach" id="addFoodQuantity" autofocus></paper-input>
      </p>
      <div class="buttons">
        <paper-button dialog-dismiss>Anuluj</paper-button>
        <paper-button dialog-confirm on-tap="addSelectedFoodToList">Dodaj do listy tygodniowej</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'glu-polydiet',
      properties: {
        selectedTab: {
          type: Number,
          value: 0
        },
        foods: {
          type: Array,
          notify: true,
          value: []
        },
        weeklyProducts: {
          type: Array,
          notify: true,
          value: []
        },
        prodSearch: {
          type: String,
          notify: true,
          value: ""
        },
        selectedFood: {
          type: Object,
          notify: true,
          value: null
        },
        isFoodSelected: {
          type: Boolean,
          notify: true,
          value: false
        }
      },
      behaviors: [GluBehaviors.GridSort],
      observers: [
        '_filterAndSortFoods(foods, prodSearch, sortOrder)'
      ],
      addSelectedFoodToList: function () {
        var amount = this.$.addFoodQuantity.value,
          foodWithAmount;

        if (amount > 0) {
          foodWithAmount = Object.assign({}, this.selectedFood);
          foodWithAmount.a = parseFloat(amount);
          this.push("weeklyProducts", foodWithAmount);
          this.$.foodsList.resetSelected();
        }
      },
      removeFoodsFromList: function (e, data) {
        data.products.forEach(function (food) {
          for (var i = 0; i < this.weeklyProducts.length; i++) {
            if (this.weeklyProducts[i].id === food.id) {
              this.splice("weeklyProducts", i, 1);
              return;
            }
          }
        }.bind(this));
      },
      openAddFoodModal: function () {
        this.$.addFoodQuantity.value = null;
        this.$.addSelectedFoodModal.open();
      },
      selectedFoodChanged: function (e, selectedFood) {
        this.isFoodSelected = selectedFood.item === null ? false : true;
        this.selectedFood = selectedFood.item;
      },
      _filterAndSortFoods: function (foods, prodSearch, sortOrder) {
        if (prodSearch.length >= 2) {
          prodSearch = prodSearch.toLowerCase();
          this.sortGrid(foods.filter(function (item) {
            return item.t.toLowerCase().indexOf(prodSearch) >= 0;
          }), sortOrder);
        } else {
          this.sortGrid(foods.concat(), sortOrder);
        }
      }
    });
  </script>
</dom-module>