<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="shared/polydiet-icons.html">
<link rel="import" href="shared/formatters-behavior.html">
<link rel="import" href="shared/shared-styles.html">
<link rel="import" href="shared/glu-progress.html">
<dom-module id="weekly-grid">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
      }
      
      #deleteProducts {
        margin: 1rem;
      }
      
      .amountInput {
        border: 0;
      }
    </style>
    <vaadin-grid id="grid" items="[[products]]" selected-items="{{selectedItems}}">
      <vaadin-grid-selection-column frozen auto-select></vaadin-grid-selection-column>
      <vaadin-grid-column frozen resizable width="200px">
        <template class="header">
          <vaadin-grid-sorter path="t" direction="asc">Produkt</vaadin-grid-sorter>
        </template>
        <template>[[item.t]]</template>
        <template class="footer">
          Suma:
        </template>
      </vaadin-grid-column>
      <vaadin-grid-column frozen resizable width="90px">
        <template class="header">
          <vaadin-grid-sorter path="a">Porcja (g)</vaadin-grid-sorter>
        </template>
        <template>
          <input value$="[[item.a]]" type="number" class="amountInput" on-change="_handleInput" itemid="[[item.id]]"></input>
        </template>
        <template class="footer">
          [[formatAmount(sums, "1")]]
        </template>
      </vaadin-grid-column>
      <template is="dom-repeat" items="[[nutrients]]" as="nutrient">
        <template is="dom-if" if="[[!nutrient.hidden]]" restamp>
          <vaadin-grid-column resizable width="[[getColumWidth(nutrient.hidden)]]">
            <template class="header">
              <vaadin-grid-sorter path="[[nutrient.path]]">[[nutrient.name]]</vaadin-grid-sorter>
            </template>
            <template>[[formatAmount(item, nutrient.path)]]</template>
            <template class="footer">
              <glu-progress text="[[formatAmount(sums, nutrient.sumPath)]]" current="[[get(nutrient.sumPath, sums)]]" limit="[[nutrient.weeklyGoal]]"></glu-progress>
            </template>
          </vaadin-grid-column>
        </template>
      </template>
    </vaadin-grid>
    <paper-fab icon="polydiet-icons:delete" id="deleteProducts" disabled="[[!isProductSelected]]" on-tap="removeSelected"></paper-fab>
  </template>
  <script>
    (function () {
      Polymer({
        is: 'weekly-grid',
        properties: {
          products: {
            type: Array,
            value: []
          },
          nutrients: {
            type: Array,
            value: []
          },
          sums: {
            type: Array,
            value: []
          },
          isProductSelected: {
            type: Boolean,
            notify: true,
            computed: '_isProductSelected(selectedItems.*)'
          },
          selectedItems: {
            type: Array,
            value: [],
            notify: true
          }
        },
        behaviors: [GluBehaviors.Formatters],
        _isProductSelected: function (rows) {
          return rows.base.length > 0 ? true : false;
        },
        _handleInput: function (e) {
          console.log(e.target.value);
          var value = parseInt(e.target.value, 10);

          if (!Number.isNaN(value) && value > 0) {
            this.fire('amount-updated', {
              id: e.target.itemid,
              value: value
            });
          }
        },
        removeSelected: function (e) {
          var selectedRows = this.$.grid.selectedItems;

          this.$.grid.selectedItems = [];

          this.fire('remove-used', {
            products: selectedRows
          });
        }
      });
    })();
  </script>
</dom-module>